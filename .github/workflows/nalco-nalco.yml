name: Nalco PDF downloader

on:
  workflow_dispatch:
    inputs:
      backfill:
        description: "Process all PDFs in pdfs/ (true/false)"
        required: false
        default: "false"
      repair:
        description: "Repair/migrate existing Excel into event/daily format (true/false)"
        required: false
        default: "false"
      page_url:
        description: "Nalco page URL to look for PDFs (optional)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure directories
        run: |
          mkdir -p pdfs data

      - name: Run nalco scraper
        env:
          PDFS_DIR: pdfs
          DATA_FILE: data/nalco_prices.xlsx
          NALCO_PAGE_URL: ${{ github.event.inputs.page_url || '' }}
        run: |
          BACKFILL="${{ github.event.inputs.backfill || 'false' }}"
          REPAIR="${{ github.event.inputs.repair || 'false' }}"
          ARGS=()
          if [ "$BACKFILL" = "true" ]; then
            ARGS+=("--backfill")
          fi
          if [ "$REPAIR" = "true" ]; then
            ARGS+=("--repair")
          fi
          # pass page url if provided
          if [ -n "${NALCO_PAGE_URL}" ]; then
            ARGS+=("--page-url" "${NALCO_PAGE_URL}")
          fi
          echo "Running nalco_scraper.py with args: ${ARGS[*]}"
          python nalco_scraper.py "${ARGS[@]}"

      - name: Commit PDFs and Excel (force commit even if nothing changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pdfs data/nalco_prices.xlsx || true
          # create an allow-empty commit so we always have a commit even if there are no staged changes
          git commit -m "Update Nalco PDFs and data" --allow-empty
          git push
